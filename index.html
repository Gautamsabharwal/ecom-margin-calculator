<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>E‑commerce Margin Calculator (Local)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7c3aed;--glass:rgba(255,255,255,0.03);--green:#22c55e;--red:#ef4444}
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{margin:0;background:linear-gradient(180deg,#071129 0%, #071a2a 100%);color:#e6eef6;min-height:100vh;padding:18px}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
    input[type=text], input[type=number], select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}
    button{background:var(--accent);border:none;color:white;padding:9px 12px;border-radius:8px;cursor:pointer}
    .row{display:flex;gap:8px}
    .small{font-size:13px;color:var(--muted)}
    .list{max-height:220px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;background:rgba(255,255,255,0.02)}
    table{width:100%;border-collapse:collapse;min-width:700px}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px;white-space:nowrap}
    .muted{color:var(--muted)}
    .calc-row{display:flex;gap:8px;align-items:center}
    .result{background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(124,58,237,0.04));padding:10px;border-radius:8px;margin-top:10px;overflow-x:auto}
    .big{font-weight:700;font-size:18px}
    .breakdown{margin-top:8px;padding:8px;background:var(--glass);border-radius:6px}
    .breakdown div{margin-bottom:4px}
    .cm1-box,.cm2-box{margin-top:12px;padding:12px;border-radius:8px;text-align:center}
    .cm1-box{background:linear-gradient(90deg, rgba(34,197,94,0.12), rgba(34,197,94,0.04));border:1px solid var(--green);}
    .cm2-box{background:linear-gradient(90deg, rgba(59,130,246,0.12), rgba(59,130,246,0.04));border:1px solid #3b82f6;}
    .cm1-box .big,.cm2-box .big{font-size:20px}
    .cm-pct{font-size:14px;color:var(--accent);margin-top:4px}
    .note{font-size:13px;color:#cde}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}.card{padding:12px}}
    .edit-btn, .del-btn {background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;padding:6px;border-radius:6px;margin-left:4px;}
    .checkbox-list{max-height:150px;overflow:auto;padding:4px;border:1px solid rgba(255,255,255,0.04);border-radius:6px;background:var(--glass);margin-bottom:8px}
    .checkbox-item{display:flex;align-items:center;gap:8px;padding:4px 0}
    .add-section{margin-top:12px;padding:8px;background:var(--glass);border-radius:8px}
    .add-section button{padding:6px 10px;font-size:12px}
    .logo {width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;font-size:18px;position:relative;overflow:hidden;}
    .logo::before {content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.1);border-radius:10px;}
    .logo-icon {width:24px;height:24px;color:white;z-index:1;}
    select[multiple] {height:120px;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <svg class="logo-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="2" width="12" height="12" rx="1" stroke="currentColor" stroke-width="1"/>
          <rect x="4" y="4" width="2" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="0.5"/>
          <rect x="7" y="4" width="2" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="0.5"/>
          <rect x="10" y="4" width="2" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="0.5"/>
          <rect x="4" y="7" width="2" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="0.5"/>
          <rect x="7" y="7" width="2" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="0.5"/>
          <rect x="10" y="7" width="2" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="0.5"/>
          <rect x="4" y="10" width="2" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="0.5"/>
          <rect x="7" y="10" width="2" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="0.5"/>
          <rect x="10" y="10" width="2" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="0.5"/>
          <rect x="13" y="13" width="1" height="1" rx="0.5" fill="currentColor"/>
        </svg>
      </div>
      <div>
        <h1>E‑commerce Margin Calculator — Local</h1>
        <div class="small muted">Calculate CM1, CM2, and Real Profit per order.</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Setup -->
      <div>
        <div class="card" id="setupCard">
          <h3>1) SKUs (CSV or Manual)</h3>
          <div class="small muted">CSV: sku,mrp,cogs</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="csvFile" type="file" accept=".csv">
            <button id="importCsvBtn">Import</button>
            <button id="downloadFormatBtn">Download format</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <input id="addSkuName" placeholder="SKU name" type="text">
            <input id="addSkuMrp" placeholder="MRP" type="number">
            <input id="addSkuCogs" placeholder="COGS" type="number">
            <button id="addSkuBtn">Add SKU</button>
          </div>

          <div class="list" id="skuList"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>2) Platforms</h3>
          <div class="list" id="platformList"></div>
          <div class="add-section">
            <h4 style="margin:0 0 8px 0;font-size:14px">Add Custom Platform</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <input id="platformName" placeholder="Platform name" type="text" style="flex:1">
              <input id="platformCommission" placeholder="Commission %" type="number" style="width:80px">
              <select id="platformBase" style="width:70px">
                <option value="SP">on SP</option>
                <option value="MRP">on MRP</option>
              </select>
              <button id="addPlatformBtn">Add</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Saved Data</h3>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="exportBtn">Export (JSON)</button>
            <button id="clearBtn">Clear All</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Calculation -->
      <div>
        <div class="card" id="calcCard">
          <h3>3) Calculate</h3>
          <label>Platforms</label>
          <select id="platformSelections" multiple></select>

          <label style="margin-top:8px">SKUs</label>
          <div class="checkbox-list" id="skuSelections"></div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1"><label>Discount %</label><input id="discount" type="number" value="0"></div>
            <div style="flex:1"><label>Opex</label><input id="opex" type="number" value="0"></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1"><label>Delivery</label><input id="delivery" type="number" value="0"></div>
            <div style="flex:1"><label>Marketing</label><input id="marketing" type="number" value="0"></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1"><label>COGS (override)</label><input id="cogs" type="number" value="0"></div>
            <div style="flex:1"></div>
          </div>

          <div class="result" id="resultBox"></div>

          <!-- CM1 -->
          <div class="cm1-box" id="cm1Box" style="display:none">
            <div class="big" id="cm1Val">-</div>
            <div class="muted">CM1</div>
            <div class="cm-pct" id="cm1Pct">-</div>
          </div>

          <!-- CM2 -->
          <div class="cm2-box" id="cm2Box" style="display:none">
            <div class="big" id="cm2Val">-</div>
            <div class="muted">CM2 (after Marketing)</div>
            <div class="cm-pct" id="cm2Pct">-</div>
          </div>

          <div class="note" style="margin-top:12px">
            <strong>Your Logic:</strong><br>
            Net Revenue = SP × 0.847 (~15.3% tax on SP)<br>
            CM1 = Net − COGS − Opex − Commission<br>
            CM2 = CM1 − Marketing
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="calcBtn">Calculate</button>
            <button id="exampleBtn">Load Your Example</button>
            <button id="copyBtn">Copy</button>
            <button id="exportCsvBtn">Export CSV</button>
            <button id="screenshotBtn">Screenshot</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Tips</h3>
          <ul class="small muted">
            <li>CM1: Gross contribution after tax, COGS, Opex, Commission</li>
            <li>CM2: CM1 minus Marketing</li>
            <li>Real Profit: What you actually keep</li>
          </ul>
        </div>
      </div>
    </div>

    <footer class="container">Local use only. Data stays on your device.</footer>
  </div>

  <script>
  (function(){
    const LS_KEY = 'ecom_mc_v2';
    let state = {platforms: [], skus: []};
    let editingPlatformIdx = -1;
    let editingSkuIdx = -1;

    // Elements
    const platformName = document.getElementById('platformName');
    const platformCommission = document.getElementById('platformCommission');
    const platformBase = document.getElementById('platformBase');
    const addPlatformBtn = document.getElementById('addPlatformBtn');
    const platformList = document.getElementById('platformList');
    const platformSelections = document.getElementById('platformSelections');

    const csvFile = document.getElementById('csvFile');
    const importCsvBtn = document.getElementById('importCsvBtn');
    const downloadFormatBtn = document.getElementById('downloadFormatBtn');
    const skuList = document.getElementById('skuList');
    const addSkuBtn = document.getElementById('addSkuBtn');
    const addSkuName = document.getElementById('addSkuName');
    const addSkuMrp = document.getElementById('addSkuMrp');
    const addSkuCogs = document.getElementById('addSkuCogs');
    const skuSelections = document.getElementById('skuSelections');

    const discount = document.getElementById('discount');
    const opex = document.getElementById('opex');
    const delivery = document.getElementById('delivery');
    const marketing = document.getElementById('marketing');
    const cogsInput = document.getElementById('cogs');

    const resultBox = document.getElementById('resultBox');
    const cm1Box = document.getElementById('cm1Box');
    const cm2Box = document.getElementById('cm2Box');
    const cm1Val = document.getElementById('cm1Val');
    const cm1Pct = document.getElementById('cm1Pct');
    const cm2Val = document.getElementById('cm2Val');
    const cm2Pct = document.getElementById('cm2Pct');

    const calcBtn = document.getElementById('calcBtn');
    const exampleBtn = document.getElementById('exampleBtn');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');
    const copyBtn = document.getElementById('copyBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const screenshotBtn = document.getElementById('screenshotBtn');

    // Init
    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(raw) state = JSON.parse(raw);
      }catch(e){}
      if(state.platforms.length === 0){
        state.platforms = [
          {name: 'AMAZON', type: 'amazon', fixedFees: [25, 45, 27]},
          {name: 'NYKAA', commission: 40, base: 'MRP'},
          {name: 'SWIGGY', commission: 25, base: 'MRP'},
          {name: 'BLINKIT', commission: 33, base: 'MRP'},
          {name: 'ZEPT O', commission: 30, base: 'MRP'},
          {name: 'MEESHO', commission: 0, base: 'MRP'},
          {name: 'PURPPLE', commission: 41, base: 'MRP'}
        ];
      }
      state.skus.forEach(s => {if(s.cogs === undefined) s.cogs = 0;});
      renderAll();
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    // Commission
    function computeCommission(sp, mrp, platform){
      if(platform.type === 'amazon'){
        let referral = 0;
        if(sp >= 300 && sp <= 500) referral = sp * 0.065;
        else if(sp > 500) referral = sp * 0.09;
        const totalFixed = platform.fixedFees.reduce((a,b)=>a+b, 0);
        return {total: referral + totalFixed, breakdown: {referral, fixed: platform.fixedFees[0], logistics: platform.fixedFees[1], pickpack: platform.fixedFees[2]}};
      } else {
        const baseVal = platform.base === 'SP' ? sp : mrp;
        const amount = baseVal * (platform.commission / 100);
        return {total: amount, breakdown: null};
      }
    }

    // Render
    function renderPlatforms(){
      platformList.innerHTML = '';
      state.platforms.forEach((p, idx) => {
        const div = document.createElement('div');
        div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems = 'center'; div.style.marginBottom = '6px';
        let desc = p.type === 'amazon' ? '(Tiered + Fixed)' : `(${p.commission}% on ${p.base})`;
        div.innerHTML = `<div><strong>${escapeHtml(p.name)}</strong> <span class="muted">${desc}</span></div>`;
        const row = document.createElement('div');
        if(p.type !== 'amazon'){
          const edit = document.createElement('button'); edit.textContent='Edit'; edit.className='edit-btn'; edit.onclick=()=>{ platformName.value = p.name; platformCommission.value = p.commission; platformBase.value = p.base; editingPlatformIdx = idx; addPlatformBtn.textContent = 'Update'; };
          row.appendChild(edit);
        }
        const del = document.createElement('button'); del.textContent='Delete'; del.className='del-btn'; del.onclick=()=>{ if(confirm('Delete?')){state.platforms.splice(idx,1); save(); renderAll();}};
        row.appendChild(del);
        div.appendChild(row);
        platformList.appendChild(div);
      });
      renderPlatformSelections();
    }

    function renderPlatformSelections(){
      platformSelections.innerHTML = '';
      state.platforms.forEach(p => {
        const opt = document.createElement('option');
        opt.value = escapeHtml(p.name);
        let desc = p.type === 'amazon' ? '(Tiered + Fixed)' : `(${p.commission}% on ${p.base})`;
        opt.textContent = `${escapeHtml(p.name)} ${desc}`;
        platformSelections.appendChild(opt);
      });
    }

    addPlatformBtn.addEventListener('click', () => {
      const name = platformName.value.trim();
      const commission = parseFloat(platformCommission.value);
      const base = platformBase.value;
      if(!name || isNaN(commission) || commission < 0) return alert('Invalid input');
      if(editingPlatformIdx !== -1){
        state.platforms[editingPlatformIdx].name = name;
        state.platforms[editingPlatformIdx].commission = commission;
        state.platforms[editingPlatformIdx].base = base;
        editingPlatformIdx = -1;
        addPlatformBtn.textContent = 'Add';
      } else {
        state.platforms.push({name, commission, base});
      }
      platformName.value=''; platformCommission.value=''; platformBase.value='SP'; save(); renderAll();
    });

    // SKUs
    function renderSkus(){
      skuList.innerHTML = '';
      const table = document.createElement('table');
      const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>SKU</th><th>MRP</th><th>COGS</th><th></th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      state.skus.forEach((s, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(s.sku)}</td><td>₹ ${formatNumber(s.mrp)}</td><td>₹ ${formatNumber(s.cogs)}</td><td></td>`;
        const td = tr.querySelector('td:last-child');
        const edit = document.createElement('button'); edit.textContent='Edit'; edit.className='edit-btn'; edit.onclick=()=>{ addSkuName.value = s.sku; addSkuMrp.value = s.mrp; addSkuCogs.value = s.cogs; editingSkuIdx = idx; addSkuBtn.textContent = 'Update'; };
        const del = document.createElement('button'); del.textContent='Delete'; del.className='del-btn'; del.onclick=()=>{ if(confirm('Delete?')){ state.skus.splice(idx,1); save(); renderAll(); } };
        td.appendChild(edit); td.appendChild(del);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      skuList.appendChild(table);
      renderSkuSelections();
    }

    function renderSkuSelections(){
      skuSelections.innerHTML = '';
      state.skus.forEach(s => {
        const item = document.createElement('div');
        item.className = 'checkbox-item';
        item.innerHTML = `<input type="checkbox" value="${escapeHtml(s.sku)}" id="sku_${s.sku}"> <label for="sku_${s.sku}" style="margin:0;cursor:pointer;flex:1">${escapeHtml(s.sku)} (₹${s.mrp}, COGS ₹${s.cogs})</label>`;
        skuSelections.appendChild(item);
      });
    }

    addSkuBtn.addEventListener('click', () => {
      const sku = addSkuName.value.trim();
      const mrp = parseFloat(addSkuMrp.value);
      const cogs = parseFloat(addSkuCogs.value) || 0;
      if(!sku || isNaN(mrp) || mrp < 0) return alert('Invalid');
      if(editingSkuIdx !== -1){
        state.skus[editingSkuIdx].sku = sku;
        state.skus[editingSkuIdx].mrp = mrp;
        state.skus[editingSkuIdx].cogs = cogs;
        editingSkuIdx = -1;
        addSkuBtn.textContent = 'Add SKU';
      } else {
        state.skus.push({sku, mrp, cogs});
      }
      addSkuName.value=''; addSkuMrp.value=''; addSkuCogs.value=''; save(); renderAll();
    });

    // CSV
    importCsvBtn.addEventListener('click', () => {
      const f = csvFile.files[0];
      if(!f) return alert('Choose file');
      const reader = new FileReader();
      reader.onload = e => {
        const txt = e.target.result;
        const rows = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean).map(l => l.split(',').map(c => c.trim().replace(/"/g,'')));
        if(rows.length > 0 && isNaN(parseFloat(rows[0][1]))) rows.shift();
        let added = 0;
        rows.forEach(row => {
          if(row.length < 2) return;
          const sku = row[0]; const mrp = parseFloat(row[1]); const cogs = row[2] ? parseFloat(row[2]) : 0;
          if(sku && !isNaN(mrp)) { state.skus.push({sku, mrp, cogs}); added++; }
        });
        save(); renderAll(); alert('Imported ' + added);
      };
      reader.readAsText(f);
    });

    downloadFormatBtn.addEventListener('click', () => {
      const csv = "SKU Name,MRP,COGS\nCCBBSM01,249,25\n";
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = 'sample_skus.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // Prefill COGS
    skuSelections.addEventListener('change', () => {
      const checked = Array.from(skuSelections.querySelectorAll('input:checked')).map(cb => cb.value);
      if(checked.length === 1){
        const sku = state.skus.find(s => s.sku === checked[0]);
        if(sku) cogsInput.value = sku.cogs;
      } else {
        cogsInput.value = 0;
      }
    });

    // Compute
    function computeResults(){
      const plats = Array.from(platformSelections.selectedOptions).map(opt => opt.value);
      const skus = Array.from(skuSelections.querySelectorAll('input:checked')).map(cb => cb.value);
      const isSingle = skus.length === 1;
      if(plats.length === 0 || skus.length === 0) return [];
      const disc = parseFloat(discount.value) || 0;
      const o = parseFloat(opex.value) || 0;
      const deliv = parseFloat(delivery.value) || 0;
      const mark = parseFloat(marketing.value) || 0;
      const overrideCogs = parseFloat(cogsInput.value) || 0;
      const results = [];

      plats.forEach(pname => {
        const platform = state.platforms.find(p => p.name === pname);
        if(!platform) return;
        skus.forEach(sname => {
          const sku = state.skus.find(s => s.sku === sname);
          if(!sku) return;
          const sp = round2(sku.mrp * (1 - disc / 100));
          const comm = computeCommission(sp, sku.mrp, platform);
          const settlement = round2(sp - comm.total);
          const netRevenue = round2(sp * 0.847);  // Your tax logic
          const cogs = isSingle ? overrideCogs : sku.cogs;
          const cm1 = round2(netRevenue - cogs - o - comm.total);
          const cm1Pct = netRevenue !== 0 ? round2((cm1 / netRevenue) * 100) : 0;
          const cm2 = round2(cm1 - mark);
          const cm2Pct = netRevenue !== 0 ? round2((cm2 / netRevenue) * 100) : 0;
          results.push({platform: pname, sku: sname, sp, settlement, netRevenue, commTotal: comm.total, cogs, cm1, cm1Pct, cm2, cm2Pct, opex: o, delivery: deliv, marketing: mark, commBreakdown: comm.breakdown});
        });
      });
      return results;
    }

    function calculate(){
      resultBox.innerHTML = ''; cm1Box.style.display = 'none'; cm2Box.style.display = 'none';
      const results = computeResults();
      if(results.length === 0) return alert('Select platform and SKU');
      if(results.length > 6) { resultBox.innerHTML = '<div class="muted">Too many results. Export CSV.</div>'; return; }

      if(results.length === 1){
        const r = results[0];
        let breakdown = '';
        if(r.commBreakdown){
          breakdown = `<div class="breakdown">
            <div><strong>Commission:</strong></div>
            <div>Referral: ₹ ${formatNumber(r.commBreakdown.referral)}</div>
            <div>Fixed: ₹ ${formatNumber(r.commBreakdown.fixed)}</div>
            <div>Logistics: ₹ ${formatNumber(r.commBreakdown.logistics)}</div>
            <div>Pick & Pack: ₹ ${formatNumber(r.commBreakdown.pickpack)}</div>
            <div><strong>Total: ₹ ${formatNumber(r.commTotal)}</strong></div>
          </div>`;
        }
        resultBox.innerHTML = `
          <div class="calc-row"><div class="muted">SP:</div><div style="margin-left:auto">₹ ${formatNumber(r.sp)}</div></div>
          <div class="calc-row"><div class="muted">Net (After taxes):</div><div style="margin-left:auto">₹ ${formatNumber(r.netRevenue)}</div></div>
          <div class="calc-row"><div class="muted">Settlement:</div><div style="margin-left:auto">₹ ${formatNumber(r.settlement)}</div></div>
          ${breakdown}
        `;
        cm1Val.textContent = (r.cm1 >= 0 ? '₹ ' : '−₹ ') + formatNumber(Math.abs(r.cm1)); cm1Pct.textContent = r.cm1Pct + '%'; cm1Box.style.display = 'block';
        cm2Val.textContent = (r.cm2 >= 0 ? '₹ ' : '−₹ ') + formatNumber(Math.abs(r.cm2)); cm2Pct.textContent = r.cm2Pct + '%'; cm2Box.style.display = 'block';
      } else {
        const table = document.createElement('table');
        table.innerHTML = '<thead><tr><th>Plat</th><th>SKU</th><th>SP</th><th>Net</th><th>Settlement</th><th>Comm</th><th>CM1</th><th>CM1%</th><th>CM2</th><th>CM2%</th></tr></thead><tbody>';
        results.forEach(r => {
          table.innerHTML += `<tr>
            <td>${escapeHtml(r.platform)}</td><td>${escapeHtml(r.sku)}</td>
            <td>₹ ${formatNumber(r.sp)}</td><td>₹ ${formatNumber(r.netRevenue)}</td>
            <td>₹ ${formatNumber(r.settlement)}</td><td>₹ ${formatNumber(r.commTotal)}</td>
            <td>${(r.cm1 >= 0 ? '' : '−')}₹ ${formatNumber(Math.abs(r.cm1))}</td><td>${r.cm1Pct}%</td>
            <td>${(r.cm2 >= 0 ? '' : '−')}₹ ${formatNumber(Math.abs(r.cm2))}</td><td>${r.cm2Pct}%</td>
          </tr>`;
        });
        table.innerHTML += '</tbody>';
        resultBox.appendChild(table);
      }
    }

    calcBtn.addEventListener('click', calculate);

    exampleBtn.addEventListener('click', () => {
      const sidx = state.skus.findIndex(s => s.sku === 'CCBBSM01');
      if(sidx === -1) state.skus.push({sku: 'CCBBSM01', mrp: 249, cogs: 25});
      save(); renderAll();
      const amazonOpt = Array.from(platformSelections.options).find(opt => opt.value === 'AMAZON');
      if(amazonOpt) amazonOpt.selected = true;
      const skuCb = skuSelections.querySelector('input[value="CCBBSM01"]');
      if(skuCb) skuCb.checked = true;
      discount.value = 40; opex.value = 11; delivery.value = 0; marketing.value = 0; cogsInput.value = 25;
      calculate();
    });

    // Export/Copy
    copyBtn.addEventListener('click', () => {
      const results = computeResults();
      if(results.length === 0) return;
      const txt = results.map(r => `Platform: ${r.platform}\nSKU: ${r.sku}\nSP: ₹${formatNumber(r.sp)}\nNet (After taxes): ₹${formatNumber(r.netRevenue)}\nSettlement: ₹${formatNumber(r.settlement)}\nCommission: ₹${formatNumber(r.commTotal)}\nCM1: ${r.cm1 >= 0 ? '' : '-'}₹${formatNumber(Math.abs(r.cm1))} (${r.cm1Pct}%)\nCM2: ${r.cm2 >= 0 ? '' : '-'}₹${formatNumber(Math.abs(r.cm2))} (${r.cm2Pct}%)`).join('\n\n');
      navigator.clipboard.writeText(txt).then(() => alert('Copied'));
    });

    exportCsvBtn.addEventListener('click', () => {
      const results = computeResults();
      if(results.length === 0) return;
      const header = `Platform,SKU,SP,Net,Settlement,Commission,COGS,Opex,CM1,CM1%,CM2,CM2%\n`;
      const rows = results.map(r => `"${r.platform}","${r.sku}",${r.sp},${r.netRevenue},${r.settlement},${r.commTotal},${r.cogs},${r.opex},${r.cm1},${r.cm1Pct},${r.cm2},${r.cm2Pct}`).join('\n');
      const blob = new Blob([header + rows], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='results.csv'; a.click(); URL.revokeObjectURL(url);
    });

    screenshotBtn.addEventListener('click', () => {
      html2canvas(document.getElementById('calcCard')).then(canvas => {
        const a = document.createElement('a'); a.download='result.png'; a.href=canvas.toDataURL(); a.click();
      });
    });

    function renderAll(){ renderPlatforms(); renderSkus(); }
    function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
    function formatNumber(n){ return Math.abs(n).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    load();
  })();
  </script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>